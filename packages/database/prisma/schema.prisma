generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Enums ───────────────────────────────────────────────────

enum RoleT {
  platform_admin
  business_admin
  manager
  curator
  staff
  accounting

  @@map("role_t")
}

enum CountingMethodT {
  weighable
  unit_count
  keg

  @@map("counting_method_t")
}

enum UomT {
  units
  oz
  ml
  grams
  L

  @@map("uom_t")
}

enum SourceSystemT {
  toast
  square
  lightspeed
  clover
  other
  manual

  @@map("source_system_t")
}

enum MappingModeT {
  packaged_unit
  draft_by_tap
  draft_by_product
  recipe

  @@map("mapping_mode_t")
}

enum KegStatusT {
  in_storage
  in_service
  empty
  returned

  @@map("keg_status_t")
}

enum ParUomT {
  unit
  package

  @@map("par_uom_t")
}

enum PurchaseOrderStatusT {
  open
  partially_fulfilled
  closed

  @@map("purchase_order_status_t")
}

enum EventTypeT {
  pos_sale
  tap_flow
  manual_adjustment
  inventory_count_adjustment
  transfer
  receiving

  @@map("event_type_t")
}

enum ConfidenceLevelT {
  theoretical
  measured
  estimated

  @@map("confidence_level_t")
}

enum VarianceReasonT {
  waste_foam
  comp
  staff_drink
  theft
  breakage
  line_cleaning
  transfer
  unknown
  session_expired

  @@map("variance_reason_t")
}

enum SessionTypeT {
  shift
  daily
  weekly
  monthly
  receiving

  @@map("session_type_t")
}

// ─── Art Enums ──────────────────────────────────────────────

enum ArtworkStatusT {
  on_wall
  reserved_pending_payment
  reserved
  sold
  removed
  removed_not_sold
  pending_payment_issue

  @@map("artwork_status_t")
}

enum AgreementTypeT {
  consignment
  owned

  @@map("agreement_type_t")
}

enum SaleModeT {
  platform_sale
  direct_artist_sale
  either

  @@map("sale_mode_t")
}

enum PayoutMethodT {
  etransfer
  cheque
  cash
  other

  @@map("payout_method_t")
}

enum PaymentMethodT {
  cash
  debit
  credit
  etransfer
  other

  @@map("payment_method_t")
}

// ─── Multi-tenant ────────────────────────────────────────────

model Business {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name         String
  slug         String   @unique
  contactEmail String?  @map("contact_email")
  contactPhone String?  @map("contact_phone")
  address      String?
  logoUrl      String?  @map("logo_url")
  logoKey      String?  @map("logo_key")
  active       Boolean  @default(true)
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz()

  locations        Location[]
  users            User[]
  kegSizes         KegSize[]
  bottleTemplates  BottleTemplate[]
  auditLogs        AuditLog[]
  businessSettings BusinessSettings?
  notifications    Notification[]
  artists          Artist[]
  artworks         Artwork[]
  artSales         ArtSale[]
  vendors          Vendor[]
  itemCategories   InventoryItemCategory[]

  @@map("businesses")
}

// ─── Core ────────────────────────────────────────────────────

model Location {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  timezone    String   @default("America/Montreal")
  closeoutHour Int     @default(4) @map("closeout_hour")
  address    String?
  city       String?
  province   String?
  postalCode String?  @map("postal_code")
  phone      String?
  active     Boolean  @default(true)
  businessId  String   @map("business_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz()

  business         Business           @relation(fields: [businessId], references: [id])
  users            User[]
  userLocations    UserLocation[]
  inventoryItems   InventoryItem[]
  kegInstances     KegInstance[]
  tapLines         TapLine[]
  tapAssignments   TapAssignment[]
  pourProfiles     PourProfile[]
  posConnections   POSConnection[]
  salesLines       SalesLine[]
  consumptionEvents ConsumptionEvent[]
  inventorySessions InventorySession[]
  bottleTemplates  BottleTemplate[]
  bottleMeasurements BottleMeasurement[]
  posMappings      POSItemMapping[]
  barAreas         BarArea[]
  guideCategories  ProductGuideCategory[]
  guideItems       ProductGuideItem[]
  scaleProfiles    ScaleProfile[]
  recipes          Recipe[]
  parLevels        ParLevel[]
  purchaseOrders   PurchaseOrder[]
  csvImports       CSVImport[]

  @@map("locations")
}

model User {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email        String   @unique
  firstName    String?  @map("first_name")
  lastName     String?  @map("last_name")
  phone        String?
  pin          String?  @db.Char(4)
  passwordHash String   @map("password_hash")
  role         RoleT
  locationId   String   @map("location_id") @db.Uuid
  businessId   String   @map("business_id") @db.Uuid
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz()

  location              Location              @relation(fields: [locationId], references: [id])
  business              Business              @relation(fields: [businessId], references: [id])
  userLocations         UserLocation[]
  createdSessions       InventorySession[]    @relation("SessionCreatedBy")
  closedSessions        InventorySession[]    @relation("SessionClosedBy")
  bottleMeasurements    BottleMeasurement[]
  artSalesRecorded      ArtSale[]
  auditLogs             AuditLog[]
  notifications         Notification[]
  passwordResetTokens   PasswordResetToken[]
  scaleProfileConnections ScaleProfile[]
  sessionParticipations   SessionParticipant[]
  countedSessionLines     InventorySessionLine[] @relation("LineCountedBy")
  createdPurchaseOrders   PurchaseOrder[]        @relation("PurchaseOrderCreatedBy")
  vendorOrderers          VendorOrderer[]
  deviceTokens            DeviceToken[]
  csvImports              CSVImport[]

  @@map("users")
}

model UserLocation {
  userId      String @map("user_id") @db.Uuid
  locationId  String @map("location_id") @db.Uuid
  role        RoleT
  permissions Json?  @default("{}") @map("permissions")

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@id([userId, locationId])
  @@map("user_locations")
}

// ─── Item Categories ────────────────────────────────────────

model InventoryItemCategory {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  businessId      String          @map("business_id") @db.Uuid
  name            String          @db.VarChar(100)
  countingMethod  CountingMethodT @map("counting_method")
  defaultDensity  Decimal?        @map("default_density") @db.Decimal(6, 4)
  sortOrder       Int             @default(0) @map("sort_order")
  active          Boolean         @default(true)
  createdAt       DateTime        @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt       DateTime        @updatedAt @map("updated_at") @db.Timestamptz()

  business       Business        @relation(fields: [businessId], references: [id])
  inventoryItems InventoryItem[]

  @@unique([businessId, name])
  @@index([businessId], map: "ix_item_categories_business")
  @@map("inventory_item_categories")
}

// ─── Inventory ───────────────────────────────────────────────

model InventoryItem {
  id         String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  locationId String             @map("location_id") @db.Uuid
  categoryId String?            @map("category_id") @db.Uuid
  name       String
  barcode    String?
  vendorSku  String?            @map("vendor_sku")
  vendorId   String?            @map("vendor_id") @db.Uuid
  baseUom    UomT               @map("base_uom")
  packSize      Decimal?           @map("pack_size")
  packUom       UomT?              @map("pack_uom")
  containerSize Decimal?           @map("container_size")
  containerUom  UomT?              @map("container_uom")
  active        Boolean            @default(true)
  createdAt  DateTime           @default(now()) @map("created_at") @db.Timestamptz()

  location           Location             @relation(fields: [locationId], references: [id])
  category           InventoryItemCategory? @relation(fields: [categoryId], references: [id])
  vendor             Vendor?              @relation(fields: [vendorId], references: [id])
  itemVendors        ItemVendor[]
  priceHistory       PriceHistory[]
  kegInstances       KegInstance[]
  consumptionEvents  ConsumptionEvent[]
  sessionLines       InventorySessionLine[]
  posMappings        POSItemMapping[]
  bottleTemplates    BottleTemplate[]
  bottleMeasurements BottleMeasurement[]
  guideItems         ProductGuideItem[]
  recipeIngredients  RecipeIngredient[]
  parLevels          ParLevel[]
  purchaseOrderLines PurchaseOrderLine[]

  @@index([locationId], map: "ix_inventory_items_location")
  @@map("inventory_items")
}

model PriceHistory {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  inventoryItemId String    @map("inventory_item_id") @db.Uuid
  unitCost        Decimal   @map("unit_cost")
  containerCost   Decimal?  @map("container_cost")
  currency        String    @default("CAD")
  effectiveFromTs DateTime  @map("effective_from_ts") @db.Timestamptz()
  effectiveToTs   DateTime? @map("effective_to_ts") @db.Timestamptz()
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz()

  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id])

  @@index([inventoryItemId, effectiveFromTs], map: "ix_price_history_item_from")
  @@map("price_history")
}

// ─── Draft Beer ──────────────────────────────────────────────

model KegSize {
  id         String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  businessId String  @map("business_id") @db.Uuid
  name       String
  totalOz    Decimal @map("total_oz")

  business     Business      @relation(fields: [businessId], references: [id])
  kegInstances KegInstance[]

  @@map("keg_sizes")
}

model KegInstance {
  id              String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  locationId      String     @map("location_id") @db.Uuid
  inventoryItemId String     @map("inventory_item_id") @db.Uuid
  kegSizeId       String     @map("keg_size_id") @db.Uuid
  status          KegStatusT @default(in_storage)
  receivedTs      DateTime   @map("received_ts") @db.Timestamptz()
  tappedTs        DateTime?  @map("tapped_ts") @db.Timestamptz()
  emptiedTs       DateTime?  @map("emptied_ts") @db.Timestamptz()
  startingOz      Decimal    @map("starting_oz")
  notes           String?
  createdAt       DateTime   @default(now()) @map("created_at") @db.Timestamptz()

  location      Location      @relation(fields: [locationId], references: [id])
  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id])
  kegSize       KegSize       @relation(fields: [kegSizeId], references: [id])
  tapAssignments TapAssignment[]
  consumptionEvents ConsumptionEvent[]
  sessionLines  InventorySessionLine[]

  @@index([locationId], map: "ix_keg_instances_location")
  @@index([inventoryItemId], map: "ix_keg_instances_item")
  @@map("keg_instances")
}

model TapLine {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  locationId String   @map("location_id") @db.Uuid
  barAreaId  String?  @map("bar_area_id") @db.Uuid
  name       String
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz()

  location       Location          @relation(fields: [locationId], references: [id])
  barArea        BarArea?          @relation(fields: [barAreaId], references: [id])
  tapAssignments TapAssignment[]
  consumptionEvents ConsumptionEvent[]
  posMappings    POSItemMapping[]
  sessionLines   InventorySessionLine[]

  @@map("tap_lines")
}

model TapAssignment {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  locationId       String    @map("location_id") @db.Uuid
  tapLineId        String    @map("tap_line_id") @db.Uuid
  kegInstanceId    String    @map("keg_instance_id") @db.Uuid
  effectiveStartTs DateTime  @map("effective_start_ts") @db.Timestamptz()
  effectiveEndTs   DateTime? @map("effective_end_ts") @db.Timestamptz()
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz()

  location    Location    @relation(fields: [locationId], references: [id])
  tapLine     TapLine     @relation(fields: [tapLineId], references: [id])
  kegInstance KegInstance @relation(fields: [kegInstanceId], references: [id])

  @@index([tapLineId, effectiveStartTs], map: "ix_tap_assign_line_time")
  @@map("tap_assignments")
}

model PourProfile {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  locationId String   @map("location_id") @db.Uuid
  name       String
  oz         Decimal
  active     Boolean  @default(true)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz()

  location    Location         @relation(fields: [locationId], references: [id])
  posMappings POSItemMapping[]

  @@map("pour_profiles")
}

// ─── POS Integration ─────────────────────────────────────────

model POSConnection {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  locationId    String    @map("location_id") @db.Uuid
  sourceSystem  SourceSystemT @map("source_system")
  method        String
  status        String    @default("active")
  lastSuccessTs DateTime? @map("last_success_ts") @db.Timestamptz()
  lastError     String?   @map("last_error")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz()

  location Location @relation(fields: [locationId], references: [id])

  @@map("pos_connections")
}

model SalesLine {
  id                String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sourceSystem      SourceSystemT @map("source_system")
  sourceLocationId  String       @map("source_location_id")
  locationId        String       @map("location_id") @db.Uuid
  businessDate      DateTime     @map("business_date") @db.Date
  soldAt            DateTime     @map("sold_at") @db.Timestamptz()
  receiptId         String       @map("receipt_id")
  lineId            String       @map("line_id")
  posItemId         String       @map("pos_item_id")
  posItemName       String       @map("pos_item_name")
  quantity          Decimal
  isVoided          Boolean      @default(false) @map("is_voided")
  isRefunded        Boolean      @default(false) @map("is_refunded")
  sizeModifierId    String?      @map("size_modifier_id")
  sizeModifierName  String?      @map("size_modifier_name")
  rawPayloadJson    Json?        @map("raw_payload_json")
  createdAt         DateTime     @default(now()) @map("created_at") @db.Timestamptz()

  location          Location           @relation(fields: [locationId], references: [id])
  consumptionEvents ConsumptionEvent[]

  @@unique([sourceSystem, sourceLocationId, businessDate, receiptId, lineId, sizeModifierId], map: "ux_salesline_idem")
  @@index([locationId, soldAt], map: "ix_sales_lines_location_time")
  @@map("sales_lines")
}

model POSItemMapping {
  id              String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  locationId      String       @map("location_id") @db.Uuid
  sourceSystem    SourceSystemT @map("source_system")
  posItemId       String       @map("pos_item_id")
  inventoryItemId String?      @map("inventory_item_id") @db.Uuid
  mode            MappingModeT
  pourProfileId   String?      @map("pour_profile_id") @db.Uuid
  tapLineId       String?      @map("tap_line_id") @db.Uuid
  recipeId        String?      @map("recipe_id") @db.Uuid
  active          Boolean      @default(true)
  effectiveFromTs DateTime     @map("effective_from_ts") @db.Timestamptz()
  effectiveToTs   DateTime?    @map("effective_to_ts") @db.Timestamptz()
  createdAt       DateTime     @default(now()) @map("created_at") @db.Timestamptz()

  location      Location       @relation(fields: [locationId], references: [id])
  inventoryItem InventoryItem? @relation(fields: [inventoryItemId], references: [id])
  pourProfile   PourProfile?   @relation(fields: [pourProfileId], references: [id])
  tapLine       TapLine?       @relation(fields: [tapLineId], references: [id])
  recipe        Recipe?        @relation(fields: [recipeId], references: [id])

  @@index([locationId, sourceSystem, posItemId, effectiveFromTs], map: "ix_mappings_lookup")
  @@map("pos_item_mappings")
}

// ─── Recipes ────────────────────────────────────────────────

model Recipe {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  locationId  String   @map("location_id") @db.Uuid
  name        String
  category    String?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz()

  location    Location           @relation(fields: [locationId], references: [id])
  ingredients RecipeIngredient[]
  posMappings POSItemMapping[]

  @@index([locationId], map: "ix_recipes_location")
  @@map("recipes")
}

model RecipeIngredient {
  id              String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  recipeId        String  @map("recipe_id") @db.Uuid
  inventoryItemId String  @map("inventory_item_id") @db.Uuid
  quantity        Decimal
  uom             UomT

  recipe        Recipe        @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id])

  @@map("recipe_ingredients")
}

// ─── Immutable Ledger ────────────────────────────────────────

model ConsumptionEvent {
  id                 String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  locationId         String           @map("location_id") @db.Uuid
  eventType          EventTypeT       @map("event_type")
  sourceSystem       SourceSystemT    @map("source_system")
  eventTs            DateTime         @map("event_ts") @db.Timestamptz()
  inventoryItemId    String           @map("inventory_item_id") @db.Uuid
  kegInstanceId      String?          @map("keg_instance_id") @db.Uuid
  tapLineId          String?          @map("tap_line_id") @db.Uuid
  receiptId          String?          @map("receipt_id")
  salesLineId        String?          @map("sales_line_id") @db.Uuid
  quantityDelta      Decimal          @map("quantity_delta")
  uom                UomT
  confidenceLevel    ConfidenceLevelT @map("confidence_level")
  varianceReason     VarianceReasonT? @map("variance_reason")
  notes              String?
  reversalOfEventId  String?          @map("reversal_of_event_id") @db.Uuid
  createdAt          DateTime         @default(now()) @map("created_at") @db.Timestamptz()

  location       Location      @relation(fields: [locationId], references: [id])
  inventoryItem  InventoryItem @relation(fields: [inventoryItemId], references: [id])
  kegInstance    KegInstance?  @relation(fields: [kegInstanceId], references: [id])
  tapLine        TapLine?      @relation(fields: [tapLineId], references: [id])
  salesLine      SalesLine?    @relation(fields: [salesLineId], references: [id])
  reversalOf     ConsumptionEvent?  @relation("EventReversal", fields: [reversalOfEventId], references: [id])
  reversedBy     ConsumptionEvent[] @relation("EventReversal")

  @@index([locationId, eventTs], map: "ix_events_loc_ts")
  @@index([inventoryItemId, eventTs], map: "ix_events_item_ts")
  @@map("consumption_events")
}

// ─── Sessions ────────────────────────────────────────────────

model InventorySession {
  id          String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  locationId  String       @map("location_id") @db.Uuid
  sessionType SessionTypeT @map("session_type")
  startedTs   DateTime     @map("started_ts") @db.Timestamptz()
  endedTs     DateTime?    @map("ended_ts") @db.Timestamptz()
  createdBy   String?      @map("created_by") @db.Uuid
  closedBy    String?      @map("closed_by") @db.Uuid
  createdAt   DateTime     @default(now()) @map("created_at") @db.Timestamptz()

  location           Location               @relation(fields: [locationId], references: [id])
  createdByUser      User?                  @relation("SessionCreatedBy", fields: [createdBy], references: [id])
  closedByUser       User?                  @relation("SessionClosedBy", fields: [closedBy], references: [id])
  lines              InventorySessionLine[]
  participants       SessionParticipant[]
  bottleMeasurements BottleMeasurement[]

  @@map("inventory_sessions")
}

model InventorySessionLine {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionId        String   @map("session_id") @db.Uuid
  inventoryItemId  String   @map("inventory_item_id") @db.Uuid
  countUnits       Decimal? @map("count_units")
  tapLineId        String?  @map("tap_line_id") @db.Uuid
  kegInstanceId    String?  @map("keg_instance_id") @db.Uuid
  percentRemaining Decimal? @map("percent_remaining")
  grossWeightGrams Decimal? @map("gross_weight_grams")
  isManual         Boolean  @default(false) @map("is_manual")
  notes            String?
  derivedMl        Decimal? @map("derived_ml")
  derivedOz        Decimal? @map("derived_oz")
  bottleTemplateId String?  @map("bottle_template_id") @db.Uuid
  confidenceLevel  String?  @map("confidence_level")
  subAreaId        String?  @map("sub_area_id") @db.Uuid
  countedBy        String?  @map("counted_by") @db.Uuid
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz()

  session       InventorySession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  inventoryItem InventoryItem    @relation(fields: [inventoryItemId], references: [id])
  tapLine       TapLine?         @relation(fields: [tapLineId], references: [id])
  kegInstance   KegInstance?     @relation(fields: [kegInstanceId], references: [id])
  bottleTemplate BottleTemplate? @relation(fields: [bottleTemplateId], references: [id])
  subArea       SubArea?         @relation(fields: [subAreaId], references: [id])
  countedByUser User?            @relation("LineCountedBy", fields: [countedBy], references: [id])

  @@index([sessionId], map: "ix_session_lines_session")
  @@map("inventory_session_lines")
}

model SessionParticipant {
  sessionId        String   @map("session_id") @db.Uuid
  userId           String   @map("user_id") @db.Uuid
  joinedAt         DateTime @default(now()) @map("joined_at") @db.Timestamptz()
  lastActiveAt     DateTime @default(now()) @map("last_active_at") @db.Timestamptz()
  currentSubAreaId String?  @map("current_sub_area_id") @db.Uuid

  session  InventorySession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user     User             @relation(fields: [userId], references: [id])
  subArea  SubArea?         @relation(fields: [currentSubAreaId], references: [id])

  @@id([sessionId, userId])
  @@map("session_participants")
}

// ─── Scale / Bottle ──────────────────────────────────────────

model BottleTemplate {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  businessId        String?  @map("business_id") @db.Uuid
  locationId        String?  @map("location_id") @db.Uuid
  inventoryItemId   String   @map("inventory_item_id") @db.Uuid
  containerSizeMl   Decimal  @map("container_size_ml")
  emptyBottleWeightG Decimal? @map("empty_bottle_weight_g")
  fullBottleWeightG  Decimal? @map("full_bottle_weight_g")
  densityGPerMl     Decimal? @map("density_g_per_ml")
  enabled           Boolean  @default(true)
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz()

  business      Business?      @relation(fields: [businessId], references: [id])
  location      Location?      @relation(fields: [locationId], references: [id])
  inventoryItem InventoryItem  @relation(fields: [inventoryItemId], references: [id])
  sessionLines  InventorySessionLine[]

  @@index([inventoryItemId], map: "ix_bottle_templates_item")
  @@map("bottle_templates")
}

model BottleMeasurement {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  locationId      String   @map("location_id") @db.Uuid
  inventoryItemId String   @map("inventory_item_id") @db.Uuid
  sessionId       String?  @map("session_id") @db.Uuid
  measuredAtTs    DateTime @map("measured_at_ts") @db.Timestamptz()
  grossWeightG    Decimal  @map("gross_weight_g")
  isManual        Boolean  @default(false) @map("is_manual")
  confidenceLevel String   @map("confidence_level")
  scaleDeviceId   String?  @map("scale_device_id")
  scaleDeviceName String?  @map("scale_device_name")
  notes           String?
  createdBy       String?  @map("created_by") @db.Uuid
  subAreaId       String?  @map("sub_area_id") @db.Uuid
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz()

  location      Location         @relation(fields: [locationId], references: [id])
  inventoryItem InventoryItem    @relation(fields: [inventoryItemId], references: [id])
  session       InventorySession? @relation(fields: [sessionId], references: [id])
  createdByUser User?            @relation(fields: [createdBy], references: [id])
  subArea       SubArea?         @relation(fields: [subAreaId], references: [id])

  @@map("bottle_measurements")
}

// ─── Scale Profiles ─────────────────────────────────────────

model ScaleProfile {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  locationId            String    @map("location_id") @db.Uuid
  name                  String
  lastHeartbeatAt       DateTime? @map("last_heartbeat_at") @db.Timestamptz()
  lastConnectedByUserId String?   @map("last_connected_by_user_id") @db.Uuid
  batteryLevel          Int?      @map("battery_level")
  lastBatteryAlertAt    DateTime? @map("last_battery_alert_at") @db.Timestamptz()
  createdAt             DateTime  @default(now()) @map("created_at") @db.Timestamptz()

  location            Location @relation(fields: [locationId], references: [id])
  lastConnectedByUser User?    @relation(fields: [lastConnectedByUserId], references: [id])

  @@unique([locationId, name])
  @@index([locationId], map: "ix_scale_profiles_location")
  @@map("scale_profiles")
}

// ─── Bar Areas ──────────────────────────────────────────────

model BarArea {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  locationId String   @map("location_id") @db.Uuid
  name       String
  sortOrder  Int      @default(0) @map("sort_order")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz()

  location Location  @relation(fields: [locationId], references: [id])
  subAreas SubArea[]
  tapLines TapLine[]

  @@index([locationId], map: "ix_bar_areas_location")
  @@map("bar_areas")
}

model SubArea {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  barAreaId String   @map("bar_area_id") @db.Uuid
  name      String
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz()

  barArea            BarArea                @relation(fields: [barAreaId], references: [id], onDelete: Cascade)
  sessionLines       InventorySessionLine[]
  bottleMeasurements BottleMeasurement[]
  activeParticipants SessionParticipant[]

  @@index([barAreaId], map: "ix_sub_areas_bar_area")
  @@map("sub_areas")
}

// ─── Product Guide ──────────────────────────────────────────

model ProductGuideCategory {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  locationId  String   @map("location_id") @db.Uuid
  name        String
  description String?
  sortOrder   Int      @default(0) @map("sort_order")
  active      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz()

  location Location             @relation(fields: [locationId], references: [id])
  items    ProductGuideItem[]

  @@index([locationId], map: "ix_guide_categories_location")
  @@map("product_guide_categories")
}

model ProductGuideItem {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  locationId      String   @map("location_id") @db.Uuid
  categoryId      String   @map("category_id") @db.Uuid
  inventoryItemId String   @map("inventory_item_id") @db.Uuid
  description     String?
  imageUrl        String?  @map("image_url")
  imageKey        String?  @map("image_key")
  prices          Json?
  abv             Decimal? @db.Decimal(4, 1)
  producer        String?
  region          String?
  vintage         Int?
  varietal        String?
  sortOrder       Int      @default(0) @map("sort_order")
  active          Boolean  @default(true)
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz()

  location      Location             @relation(fields: [locationId], references: [id])
  category      ProductGuideCategory @relation(fields: [categoryId], references: [id])
  inventoryItem InventoryItem        @relation(fields: [inventoryItemId], references: [id])

  @@index([locationId], map: "ix_guide_items_location")
  @@index([categoryId], map: "ix_guide_items_category")
  @@map("product_guide_items")
}

// ─── Vendors ────────────────────────────────────────────────

model Vendor {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  businessId   String   @map("business_id") @db.Uuid
  name         String
  contactEmail String?  @map("contact_email")
  contactPhone String?  @map("contact_phone")
  address      String?
  city         String?
  province     String?
  postalCode   String?  @map("postal_code")
  active       Boolean  @default(true)
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz()

  business        Business         @relation(fields: [businessId], references: [id])
  inventoryItems  InventoryItem[]
  itemVendors     ItemVendor[]
  parLevels       ParLevel[]
  purchaseOrders  PurchaseOrder[]
  vendorOrderers  VendorOrderer[]

  @@index([businessId], map: "ix_vendors_business")
  @@map("vendors")
}

model ItemVendor {
  inventoryItemId String   @map("inventory_item_id") @db.Uuid
  vendorId        String   @map("vendor_id") @db.Uuid
  vendorSku       String?  @map("vendor_sku")
  isPreferred     Boolean  @default(false) @map("is_preferred")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz()

  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id])
  vendor        Vendor        @relation(fields: [vendorId], references: [id])

  @@id([inventoryItemId, vendorId])
  @@map("item_vendors")
}

model VendorOrderer {
  vendorId  String   @map("vendor_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz()

  vendor Vendor @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([vendorId, userId])
  @@map("vendor_orderers")
}

// ─── Par Levels ────────────────────────────────────────────

model ParLevel {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  inventoryItemId String   @map("inventory_item_id") @db.Uuid
  vendorId        String   @map("vendor_id") @db.Uuid
  locationId      String   @map("location_id") @db.Uuid
  parLevel        Decimal  @map("par_level")
  minLevel        Decimal  @map("min_level")
  reorderQty      Decimal? @map("reorder_qty")
  parUom          ParUomT  @default(unit) @map("par_uom")
  leadTimeDays    Int      @default(1) @map("lead_time_days")
  safetyStockDays Int      @default(0) @map("safety_stock_days")
  active          Boolean  @default(true)
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz()

  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id])
  vendor        Vendor        @relation(fields: [vendorId], references: [id])
  location      Location      @relation(fields: [locationId], references: [id])

  @@unique([inventoryItemId, vendorId, locationId], map: "ux_par_level_item_vendor_location")
  @@index([locationId], map: "ix_par_levels_location")
  @@index([vendorId, locationId], map: "ix_par_levels_vendor_location")
  @@map("par_levels")
}

// ─── Purchase Orders ──────────────────────────────────────

model PurchaseOrder {
  id         String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  locationId String                @map("location_id") @db.Uuid
  vendorId   String                @map("vendor_id") @db.Uuid
  status     PurchaseOrderStatusT  @default(open)
  createdBy  String                @map("created_by") @db.Uuid
  notes      String?
  createdAt  DateTime              @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt  DateTime              @updatedAt @map("updated_at") @db.Timestamptz()
  closedAt   DateTime?             @map("closed_at") @db.Timestamptz()

  location Location            @relation(fields: [locationId], references: [id])
  vendor   Vendor              @relation(fields: [vendorId], references: [id])
  creator  User                @relation("PurchaseOrderCreatedBy", fields: [createdBy], references: [id])
  lines    PurchaseOrderLine[]

  @@index([locationId, status], map: "ix_purchase_orders_location_status")
  @@index([vendorId], map: "ix_purchase_orders_vendor")
  @@map("purchase_orders")
}

model PurchaseOrderLine {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  purchaseOrderId String   @map("purchase_order_id") @db.Uuid
  inventoryItemId String   @map("inventory_item_id") @db.Uuid
  orderedQty      Decimal  @map("ordered_qty")
  pickedUpQty     Decimal  @default(0) @map("picked_up_qty")
  orderedUom      ParUomT  @default(unit) @map("ordered_uom")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz()

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id])

  @@unique([purchaseOrderId, inventoryItemId], map: "ux_po_line_item")
  @@map("purchase_order_lines")
}

// ─── Platform Infrastructure ────────────────────────────────

model AuditLog {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  businessId   String   @map("business_id") @db.Uuid
  actorUserId  String?  @map("actor_user_id") @db.Uuid
  actionType   String   @map("action_type")
  objectType   String   @map("object_type")
  objectId     String?  @map("object_id")
  metadataJson Json?    @map("metadata_json")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz()

  business  Business @relation(fields: [businessId], references: [id])
  actorUser User?    @relation(fields: [actorUserId], references: [id])

  @@index([businessId, createdAt], map: "ix_audit_logs_business_time")
  @@index([objectType, objectId], map: "ix_audit_logs_object")
  @@map("audit_logs")
}

model BusinessSettings {
  businessId   String   @id @map("business_id") @db.Uuid
  settingsJson Json     @map("settings_json")
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz()

  business Business @relation(fields: [businessId], references: [id])

  @@map("business_settings")
}

model Notification {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  businessId      String   @map("business_id") @db.Uuid
  recipientUserId String   @map("recipient_user_id") @db.Uuid
  title           String
  body            String?
  linkUrl         String?  @map("link_url")
  imageUrl        String?  @map("image_url")
  metadataJson    Json?    @map("metadata_json")
  isRead          Boolean  @default(false) @map("is_read")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz()

  business  Business @relation(fields: [businessId], references: [id])
  recipient User     @relation(fields: [recipientUserId], references: [id])

  @@index([recipientUserId, isRead, createdAt(sort: Desc)], map: "ix_notifications_recipient")
  @@index([businessId, createdAt(sort: Desc)], map: "ix_notifications_business")
  @@map("notifications")
}

// ─── Art Sales ──────────────────────────────────────────────

model Artist {
  id                          String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  businessId                  String        @map("business_id") @db.Uuid
  name                        String
  contactEmail                String?       @map("contact_email")
  contactPhone                String?       @map("contact_phone")
  payoutMethod                PayoutMethodT? @map("payout_method")
  defaultCommissionPubPercent Decimal       @default(50) @map("default_commission_pub_percent")
  bio                         String?
  notes                       String?
  active                      Boolean       @default(true)
  createdAt                   DateTime      @default(now()) @map("created_at") @db.Timestamptz()

  business Business  @relation(fields: [businessId], references: [id])
  artworks Artwork[]
  sales    ArtSale[]

  @@index([businessId], map: "ix_artists_business")
  @@map("artists")
}

model Artwork {
  id                   String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  businessId           String          @map("business_id") @db.Uuid
  artistId             String          @map("artist_id") @db.Uuid
  title                String
  medium               String?
  dimensions           String?
  listPriceCents       Int             @map("list_price_cents")
  status               ArtworkStatusT  @default(on_wall)
  locationInPub        String?         @map("location_in_pub")
  agreementType        AgreementTypeT  @default(consignment) @map("agreement_type")
  saleMode             SaleModeT       @default(platform_sale) @map("sale_mode")
  commissionPubPercent Decimal         @map("commission_pub_percent")
  dateHung             DateTime?       @map("date_hung") @db.Date
  notes                String?
  reservedForName      String?         @map("reserved_for_name")
  reservedForContact   String?         @map("reserved_for_contact")
  createdAt            DateTime        @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt            DateTime        @updatedAt @map("updated_at") @db.Timestamptz()

  business Business       @relation(fields: [businessId], references: [id])
  artist   Artist          @relation(fields: [artistId], references: [id])
  photos   ArtworkPhoto[]
  sales    ArtSale[]

  @@index([businessId, status], map: "ix_artworks_business_status")
  @@index([artistId], map: "ix_artworks_artist")
  @@map("artworks")
}

model ArtworkPhoto {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  artworkId    String   @map("artwork_id") @db.Uuid
  storageKey   String   @map("storage_key")
  url          String
  thumbnailKey String?  @map("thumbnail_key")
  thumbnailUrl String?  @map("thumbnail_url")
  sortOrder    Int      @default(0) @map("sort_order")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz()

  artwork Artwork @relation(fields: [artworkId], references: [id], onDelete: Cascade)

  @@index([artworkId], map: "ix_artwork_photos_artwork")
  @@map("artwork_photos")
}

model ArtSale {
  id                   String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  businessId           String         @map("business_id") @db.Uuid
  artworkId            String         @map("artwork_id") @db.Uuid
  artistId             String         @map("artist_id") @db.Uuid
  salePriceCents       Int            @map("sale_price_cents")
  commissionPubPercent Decimal        @map("commission_pub_percent")
  pubCutCents          Int            @map("pub_cut_cents")
  artistCutCents       Int            @map("artist_cut_cents")
  paymentMethod        PaymentMethodT @map("payment_method")
  paymentStatus        String         @default("confirmed") @map("payment_status")
  buyerName            String?        @map("buyer_name")
  buyerContact         String?        @map("buyer_contact")
  notes                String?
  recordedByUserId     String         @map("recorded_by_user_id") @db.Uuid
  soldAt               DateTime       @default(now()) @map("sold_at") @db.Timestamptz()
  createdAt            DateTime       @default(now()) @map("created_at") @db.Timestamptz()

  business     Business @relation(fields: [businessId], references: [id])
  artwork      Artwork  @relation(fields: [artworkId], references: [id])
  artist       Artist   @relation(fields: [artistId], references: [id])
  recordedBy   User     @relation(fields: [recordedByUserId], references: [id])

  @@index([businessId, soldAt], map: "ix_art_sales_business_sold")
  @@index([artistId], map: "ix_art_sales_artist")
  @@map("art_sales")
}

// ─── Device Tokens (Push Notifications) ─────────────────────

model DeviceToken {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  token     String   @unique
  platform  String   @db.VarChar(10)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz()

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "ix_device_tokens_user")
  @@map("device_tokens")
}

// ─── CSV Imports ────────────────────────────────────────────

model CSVImport {
  id              String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  locationId      String        @map("location_id") @db.Uuid
  sourceSystem    SourceSystemT @map("source_system")
  templateName    String?       @map("template_name")
  fileName        String        @map("file_name")
  rowCount        Int           @map("row_count")
  insertedCount   Int           @map("inserted_count")
  skippedCount    Int           @map("skipped_count")
  errorCount      Int           @map("error_count")
  businessDateMin DateTime?     @map("business_date_min") @db.Date
  businessDateMax DateTime?     @map("business_date_max") @db.Date
  depletionStats  Json?         @map("depletion_stats")
  uploadedBy      String        @map("uploaded_by") @db.Uuid

  createdAt       DateTime      @default(now()) @map("created_at") @db.Timestamptz()

  location Location @relation(fields: [locationId], references: [id])
  uploader User     @relation(fields: [uploadedBy], references: [id])

  @@index([locationId, createdAt(sort: Desc)], map: "ix_csv_imports_location_time")
  @@map("csv_imports")
}

// ─── Password Reset ─────────────────────────────────────────

model PasswordResetToken {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  token     String   @unique
  expiresAt DateTime @map("expires_at") @db.Timestamptz()
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz()

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_reset_tokens")
}
