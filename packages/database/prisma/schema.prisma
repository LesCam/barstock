generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Enums ───────────────────────────────────────────────────

enum RoleT {
  platform_admin
  business_admin
  manager
  curator
  staff
  accounting

  @@map("role_t")
}

enum InventoryItemTypeT {
  packaged_beer
  keg_beer
  liquor
  wine
  food
  misc

  @@map("inventory_item_type_t")
}

enum UomT {
  units
  oz
  ml
  grams
  L

  @@map("uom_t")
}

enum SourceSystemT {
  toast
  square
  lightspeed
  clover
  other
  manual

  @@map("source_system_t")
}

enum MappingModeT {
  packaged_unit
  draft_by_tap
  draft_by_product

  @@map("mapping_mode_t")
}

enum KegStatusT {
  in_storage
  in_service
  empty
  returned

  @@map("keg_status_t")
}

enum EventTypeT {
  pos_sale
  tap_flow
  manual_adjustment
  inventory_count_adjustment
  transfer

  @@map("event_type_t")
}

enum ConfidenceLevelT {
  theoretical
  measured
  estimated

  @@map("confidence_level_t")
}

enum VarianceReasonT {
  waste_foam
  comp
  staff_drink
  theft
  breakage
  line_cleaning
  transfer
  unknown

  @@map("variance_reason_t")
}

enum SessionTypeT {
  shift
  daily
  weekly
  monthly

  @@map("session_type_t")
}

// ─── Art Enums ──────────────────────────────────────────────

enum ArtworkStatusT {
  on_wall
  reserved_pending_payment
  reserved
  sold
  removed
  removed_not_sold
  pending_payment_issue

  @@map("artwork_status_t")
}

enum AgreementTypeT {
  consignment
  owned

  @@map("agreement_type_t")
}

enum SaleModeT {
  platform_sale
  direct_artist_sale
  either

  @@map("sale_mode_t")
}

enum PayoutMethodT {
  etransfer
  cheque
  cash
  other

  @@map("payout_method_t")
}

// ─── Multi-tenant ────────────────────────────────────────────

model Business {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name         String
  slug         String   @unique
  contactEmail String?  @map("contact_email")
  contactPhone String?  @map("contact_phone")
  address      String?
  logoUrl      String?  @map("logo_url")
  logoKey      String?  @map("logo_key")
  active       Boolean  @default(true)
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz()

  locations        Location[]
  users            User[]
  kegSizes         KegSize[]
  bottleTemplates  BottleTemplate[]
  auditLogs        AuditLog[]
  businessSettings BusinessSettings?
  notifications    Notification[]
  artists          Artist[]
  artworks         Artwork[]

  @@map("businesses")
}

// ─── Core ────────────────────────────────────────────────────

model Location {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  timezone    String   @default("America/Montreal")
  closeoutHour Int     @default(4) @map("closeout_hour")
  address    String?
  city       String?
  province   String?
  postalCode String?  @map("postal_code")
  phone      String?
  businessId  String   @map("business_id") @db.Uuid
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz()

  business         Business           @relation(fields: [businessId], references: [id])
  users            User[]
  userLocations    UserLocation[]
  inventoryItems   InventoryItem[]
  kegInstances     KegInstance[]
  tapLines         TapLine[]
  tapAssignments   TapAssignment[]
  pourProfiles     PourProfile[]
  posConnections   POSConnection[]
  salesLines       SalesLine[]
  consumptionEvents ConsumptionEvent[]
  inventorySessions InventorySession[]
  bottleTemplates  BottleTemplate[]
  bottleMeasurements BottleMeasurement[]
  posMappings      POSItemMapping[]
  barAreas         BarArea[]

  @@map("locations")
}

model User {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email        String   @unique
  firstName    String?  @map("first_name")
  lastName     String?  @map("last_name")
  phone        String?
  pin          String?  @db.Char(4)
  passwordHash String   @map("password_hash")
  role         RoleT
  locationId   String   @map("location_id") @db.Uuid
  businessId   String   @map("business_id") @db.Uuid
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz()

  location              Location              @relation(fields: [locationId], references: [id])
  business              Business              @relation(fields: [businessId], references: [id])
  userLocations         UserLocation[]
  createdSessions       InventorySession[]    @relation("SessionCreatedBy")
  closedSessions        InventorySession[]    @relation("SessionClosedBy")
  bottleMeasurements    BottleMeasurement[]
  auditLogs             AuditLog[]
  notifications         Notification[]
  passwordResetTokens   PasswordResetToken[]

  @@map("users")
}

model UserLocation {
  userId     String @map("user_id") @db.Uuid
  locationId String @map("location_id") @db.Uuid
  role       RoleT

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  location Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  @@id([userId, locationId])
  @@map("user_locations")
}

// ─── Inventory ───────────────────────────────────────────────

model InventoryItem {
  id         String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  locationId String             @map("location_id") @db.Uuid
  type       InventoryItemTypeT
  name       String
  barcode    String?
  vendorSku  String?            @map("vendor_sku")
  baseUom    UomT               @map("base_uom")
  packSize      Decimal?           @map("pack_size")
  packUom       UomT?              @map("pack_uom")
  containerSize Decimal?           @map("container_size")
  containerUom  UomT?              @map("container_uom")
  active        Boolean            @default(true)
  createdAt  DateTime           @default(now()) @map("created_at") @db.Timestamptz()

  location           Location             @relation(fields: [locationId], references: [id])
  priceHistory       PriceHistory[]
  kegInstances       KegInstance[]
  consumptionEvents  ConsumptionEvent[]
  sessionLines       InventorySessionLine[]
  posMappings        POSItemMapping[]
  bottleTemplates    BottleTemplate[]
  bottleMeasurements BottleMeasurement[]

  @@index([locationId], map: "ix_inventory_items_location")
  @@map("inventory_items")
}

model PriceHistory {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  inventoryItemId String    @map("inventory_item_id") @db.Uuid
  unitCost        Decimal   @map("unit_cost")
  currency        String    @default("CAD")
  effectiveFromTs DateTime  @map("effective_from_ts") @db.Timestamptz()
  effectiveToTs   DateTime? @map("effective_to_ts") @db.Timestamptz()
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz()

  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id])

  @@index([inventoryItemId, effectiveFromTs], map: "ix_price_history_item_from")
  @@map("price_history")
}

// ─── Draft Beer ──────────────────────────────────────────────

model KegSize {
  id         String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  businessId String  @map("business_id") @db.Uuid
  name       String
  totalOz    Decimal @map("total_oz")

  business     Business      @relation(fields: [businessId], references: [id])
  kegInstances KegInstance[]

  @@map("keg_sizes")
}

model KegInstance {
  id              String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  locationId      String     @map("location_id") @db.Uuid
  inventoryItemId String     @map("inventory_item_id") @db.Uuid
  kegSizeId       String     @map("keg_size_id") @db.Uuid
  status          KegStatusT @default(in_storage)
  receivedTs      DateTime   @map("received_ts") @db.Timestamptz()
  tappedTs        DateTime?  @map("tapped_ts") @db.Timestamptz()
  emptiedTs       DateTime?  @map("emptied_ts") @db.Timestamptz()
  startingOz      Decimal    @map("starting_oz")
  notes           String?
  createdAt       DateTime   @default(now()) @map("created_at") @db.Timestamptz()

  location      Location      @relation(fields: [locationId], references: [id])
  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id])
  kegSize       KegSize       @relation(fields: [kegSizeId], references: [id])
  tapAssignments TapAssignment[]
  consumptionEvents ConsumptionEvent[]
  sessionLines  InventorySessionLine[]

  @@index([locationId], map: "ix_keg_instances_location")
  @@index([inventoryItemId], map: "ix_keg_instances_item")
  @@map("keg_instances")
}

model TapLine {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  locationId String   @map("location_id") @db.Uuid
  barAreaId  String?  @map("bar_area_id") @db.Uuid
  name       String
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz()

  location       Location          @relation(fields: [locationId], references: [id])
  barArea        BarArea?          @relation(fields: [barAreaId], references: [id])
  tapAssignments TapAssignment[]
  consumptionEvents ConsumptionEvent[]
  posMappings    POSItemMapping[]
  sessionLines   InventorySessionLine[]

  @@map("tap_lines")
}

model TapAssignment {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  locationId       String    @map("location_id") @db.Uuid
  tapLineId        String    @map("tap_line_id") @db.Uuid
  kegInstanceId    String    @map("keg_instance_id") @db.Uuid
  effectiveStartTs DateTime  @map("effective_start_ts") @db.Timestamptz()
  effectiveEndTs   DateTime? @map("effective_end_ts") @db.Timestamptz()
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz()

  location    Location    @relation(fields: [locationId], references: [id])
  tapLine     TapLine     @relation(fields: [tapLineId], references: [id])
  kegInstance KegInstance @relation(fields: [kegInstanceId], references: [id])

  @@index([tapLineId, effectiveStartTs], map: "ix_tap_assign_line_time")
  @@map("tap_assignments")
}

model PourProfile {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  locationId String   @map("location_id") @db.Uuid
  name       String
  oz         Decimal
  active     Boolean  @default(true)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz()

  location    Location         @relation(fields: [locationId], references: [id])
  posMappings POSItemMapping[]

  @@map("pour_profiles")
}

// ─── POS Integration ─────────────────────────────────────────

model POSConnection {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  locationId    String    @map("location_id") @db.Uuid
  sourceSystem  SourceSystemT @map("source_system")
  method        String
  status        String    @default("active")
  lastSuccessTs DateTime? @map("last_success_ts") @db.Timestamptz()
  lastError     String?   @map("last_error")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz()

  location Location @relation(fields: [locationId], references: [id])

  @@map("pos_connections")
}

model SalesLine {
  id                String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sourceSystem      SourceSystemT @map("source_system")
  sourceLocationId  String       @map("source_location_id")
  locationId        String       @map("location_id") @db.Uuid
  businessDate      DateTime     @map("business_date") @db.Date
  soldAt            DateTime     @map("sold_at") @db.Timestamptz()
  receiptId         String       @map("receipt_id")
  lineId            String       @map("line_id")
  posItemId         String       @map("pos_item_id")
  posItemName       String       @map("pos_item_name")
  quantity          Decimal
  isVoided          Boolean      @default(false) @map("is_voided")
  isRefunded        Boolean      @default(false) @map("is_refunded")
  sizeModifierId    String?      @map("size_modifier_id")
  sizeModifierName  String?      @map("size_modifier_name")
  rawPayloadJson    Json?        @map("raw_payload_json")
  createdAt         DateTime     @default(now()) @map("created_at") @db.Timestamptz()

  location          Location           @relation(fields: [locationId], references: [id])
  consumptionEvents ConsumptionEvent[]

  @@unique([sourceSystem, sourceLocationId, businessDate, receiptId, lineId, sizeModifierId], map: "ux_salesline_idem")
  @@index([locationId, soldAt], map: "ix_sales_lines_location_time")
  @@map("sales_lines")
}

model POSItemMapping {
  id              String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  locationId      String       @map("location_id") @db.Uuid
  sourceSystem    SourceSystemT @map("source_system")
  posItemId       String       @map("pos_item_id")
  inventoryItemId String       @map("inventory_item_id") @db.Uuid
  mode            MappingModeT
  pourProfileId   String?      @map("pour_profile_id") @db.Uuid
  tapLineId       String?      @map("tap_line_id") @db.Uuid
  active          Boolean      @default(true)
  effectiveFromTs DateTime     @map("effective_from_ts") @db.Timestamptz()
  effectiveToTs   DateTime?    @map("effective_to_ts") @db.Timestamptz()
  createdAt       DateTime     @default(now()) @map("created_at") @db.Timestamptz()

  location      Location      @relation(fields: [locationId], references: [id])
  inventoryItem InventoryItem @relation(fields: [inventoryItemId], references: [id])
  pourProfile   PourProfile?  @relation(fields: [pourProfileId], references: [id])
  tapLine       TapLine?      @relation(fields: [tapLineId], references: [id])

  @@index([locationId, sourceSystem, posItemId, effectiveFromTs], map: "ix_mappings_lookup")
  @@map("pos_item_mappings")
}

// ─── Immutable Ledger ────────────────────────────────────────

model ConsumptionEvent {
  id                 String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  locationId         String           @map("location_id") @db.Uuid
  eventType          EventTypeT       @map("event_type")
  sourceSystem       SourceSystemT    @map("source_system")
  eventTs            DateTime         @map("event_ts") @db.Timestamptz()
  inventoryItemId    String           @map("inventory_item_id") @db.Uuid
  kegInstanceId      String?          @map("keg_instance_id") @db.Uuid
  tapLineId          String?          @map("tap_line_id") @db.Uuid
  receiptId          String?          @map("receipt_id")
  salesLineId        String?          @map("sales_line_id") @db.Uuid
  quantityDelta      Decimal          @map("quantity_delta")
  uom                UomT
  confidenceLevel    ConfidenceLevelT @map("confidence_level")
  varianceReason     VarianceReasonT? @map("variance_reason")
  notes              String?
  reversalOfEventId  String?          @map("reversal_of_event_id") @db.Uuid
  createdAt          DateTime         @default(now()) @map("created_at") @db.Timestamptz()

  location       Location      @relation(fields: [locationId], references: [id])
  inventoryItem  InventoryItem @relation(fields: [inventoryItemId], references: [id])
  kegInstance    KegInstance?  @relation(fields: [kegInstanceId], references: [id])
  tapLine        TapLine?      @relation(fields: [tapLineId], references: [id])
  salesLine      SalesLine?    @relation(fields: [salesLineId], references: [id])
  reversalOf     ConsumptionEvent?  @relation("EventReversal", fields: [reversalOfEventId], references: [id])
  reversedBy     ConsumptionEvent[] @relation("EventReversal")

  @@index([locationId, eventTs], map: "ix_events_loc_ts")
  @@index([inventoryItemId, eventTs], map: "ix_events_item_ts")
  @@map("consumption_events")
}

// ─── Sessions ────────────────────────────────────────────────

model InventorySession {
  id          String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  locationId  String       @map("location_id") @db.Uuid
  sessionType SessionTypeT @map("session_type")
  startedTs   DateTime     @map("started_ts") @db.Timestamptz()
  endedTs     DateTime?    @map("ended_ts") @db.Timestamptz()
  createdBy   String?      @map("created_by") @db.Uuid
  closedBy    String?      @map("closed_by") @db.Uuid
  createdAt   DateTime     @default(now()) @map("created_at") @db.Timestamptz()

  location           Location               @relation(fields: [locationId], references: [id])
  createdByUser      User?                  @relation("SessionCreatedBy", fields: [createdBy], references: [id])
  closedByUser       User?                  @relation("SessionClosedBy", fields: [closedBy], references: [id])
  lines              InventorySessionLine[]
  bottleMeasurements BottleMeasurement[]

  @@map("inventory_sessions")
}

model InventorySessionLine {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionId        String   @map("session_id") @db.Uuid
  inventoryItemId  String   @map("inventory_item_id") @db.Uuid
  countUnits       Decimal? @map("count_units")
  tapLineId        String?  @map("tap_line_id") @db.Uuid
  kegInstanceId    String?  @map("keg_instance_id") @db.Uuid
  percentRemaining Decimal? @map("percent_remaining")
  grossWeightGrams Decimal? @map("gross_weight_grams")
  isManual         Boolean  @default(false) @map("is_manual")
  notes            String?
  derivedMl        Decimal? @map("derived_ml")
  derivedOz        Decimal? @map("derived_oz")
  bottleTemplateId String?  @map("bottle_template_id") @db.Uuid
  confidenceLevel  String?  @map("confidence_level")
  subAreaId        String?  @map("sub_area_id") @db.Uuid
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz()

  session       InventorySession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  inventoryItem InventoryItem    @relation(fields: [inventoryItemId], references: [id])
  tapLine       TapLine?         @relation(fields: [tapLineId], references: [id])
  kegInstance   KegInstance?     @relation(fields: [kegInstanceId], references: [id])
  bottleTemplate BottleTemplate? @relation(fields: [bottleTemplateId], references: [id])
  subArea       SubArea?         @relation(fields: [subAreaId], references: [id])

  @@index([sessionId], map: "ix_session_lines_session")
  @@map("inventory_session_lines")
}

// ─── Scale / Bottle ──────────────────────────────────────────

model BottleTemplate {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  businessId        String?  @map("business_id") @db.Uuid
  locationId        String?  @map("location_id") @db.Uuid
  inventoryItemId   String   @map("inventory_item_id") @db.Uuid
  containerSizeMl   Decimal  @map("container_size_ml")
  emptyBottleWeightG Decimal @map("empty_bottle_weight_g")
  fullBottleWeightG  Decimal @map("full_bottle_weight_g")
  densityGPerMl     Decimal? @map("density_g_per_ml")
  enabled           Boolean  @default(true)
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz()

  business      Business?      @relation(fields: [businessId], references: [id])
  location      Location?      @relation(fields: [locationId], references: [id])
  inventoryItem InventoryItem  @relation(fields: [inventoryItemId], references: [id])
  sessionLines  InventorySessionLine[]

  @@index([inventoryItemId], map: "ix_bottle_templates_item")
  @@map("bottle_templates")
}

model BottleMeasurement {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  locationId      String   @map("location_id") @db.Uuid
  inventoryItemId String   @map("inventory_item_id") @db.Uuid
  sessionId       String?  @map("session_id") @db.Uuid
  measuredAtTs    DateTime @map("measured_at_ts") @db.Timestamptz()
  grossWeightG    Decimal  @map("gross_weight_g")
  isManual        Boolean  @default(false) @map("is_manual")
  confidenceLevel String   @map("confidence_level")
  scaleDeviceId   String?  @map("scale_device_id")
  scaleDeviceName String?  @map("scale_device_name")
  notes           String?
  createdBy       String?  @map("created_by") @db.Uuid
  subAreaId       String?  @map("sub_area_id") @db.Uuid
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz()

  location      Location         @relation(fields: [locationId], references: [id])
  inventoryItem InventoryItem    @relation(fields: [inventoryItemId], references: [id])
  session       InventorySession? @relation(fields: [sessionId], references: [id])
  createdByUser User?            @relation(fields: [createdBy], references: [id])
  subArea       SubArea?         @relation(fields: [subAreaId], references: [id])

  @@map("bottle_measurements")
}

// ─── Bar Areas ──────────────────────────────────────────────

model BarArea {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  locationId String   @map("location_id") @db.Uuid
  name       String
  sortOrder  Int      @default(0) @map("sort_order")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz()

  location Location  @relation(fields: [locationId], references: [id])
  subAreas SubArea[]
  tapLines TapLine[]

  @@index([locationId], map: "ix_bar_areas_location")
  @@map("bar_areas")
}

model SubArea {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  barAreaId String   @map("bar_area_id") @db.Uuid
  name      String
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz()

  barArea            BarArea                @relation(fields: [barAreaId], references: [id], onDelete: Cascade)
  sessionLines       InventorySessionLine[]
  bottleMeasurements BottleMeasurement[]

  @@index([barAreaId], map: "ix_sub_areas_bar_area")
  @@map("sub_areas")
}

// ─── Platform Infrastructure ────────────────────────────────

model AuditLog {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  businessId   String   @map("business_id") @db.Uuid
  actorUserId  String?  @map("actor_user_id") @db.Uuid
  actionType   String   @map("action_type")
  objectType   String   @map("object_type")
  objectId     String?  @map("object_id")
  metadataJson Json?    @map("metadata_json")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz()

  business  Business @relation(fields: [businessId], references: [id])
  actorUser User?    @relation(fields: [actorUserId], references: [id])

  @@index([businessId, createdAt], map: "ix_audit_logs_business_time")
  @@index([objectType, objectId], map: "ix_audit_logs_object")
  @@map("audit_logs")
}

model BusinessSettings {
  businessId   String   @id @map("business_id") @db.Uuid
  settingsJson Json     @map("settings_json")
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz()

  business Business @relation(fields: [businessId], references: [id])

  @@map("business_settings")
}

model Notification {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  businessId      String   @map("business_id") @db.Uuid
  recipientUserId String   @map("recipient_user_id") @db.Uuid
  title           String
  body            String?
  linkUrl         String?  @map("link_url")
  imageUrl        String?  @map("image_url")
  metadataJson    Json?    @map("metadata_json")
  isRead          Boolean  @default(false) @map("is_read")
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz()

  business  Business @relation(fields: [businessId], references: [id])
  recipient User     @relation(fields: [recipientUserId], references: [id])

  @@index([recipientUserId, isRead, createdAt(sort: Desc)], map: "ix_notifications_recipient")
  @@index([businessId, createdAt(sort: Desc)], map: "ix_notifications_business")
  @@map("notifications")
}

// ─── Art Sales ──────────────────────────────────────────────

model Artist {
  id                          String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  businessId                  String        @map("business_id") @db.Uuid
  name                        String
  contactEmail                String?       @map("contact_email")
  contactPhone                String?       @map("contact_phone")
  payoutMethod                PayoutMethodT? @map("payout_method")
  defaultCommissionPubPercent Decimal       @default(50) @map("default_commission_pub_percent")
  bio                         String?
  notes                       String?
  active                      Boolean       @default(true)
  createdAt                   DateTime      @default(now()) @map("created_at") @db.Timestamptz()

  business Business  @relation(fields: [businessId], references: [id])
  artworks Artwork[]

  @@index([businessId], map: "ix_artists_business")
  @@map("artists")
}

model Artwork {
  id                   String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  businessId           String          @map("business_id") @db.Uuid
  artistId             String          @map("artist_id") @db.Uuid
  title                String
  medium               String?
  dimensions           String?
  listPriceCents       Int             @map("list_price_cents")
  status               ArtworkStatusT  @default(on_wall)
  locationInPub        String?         @map("location_in_pub")
  agreementType        AgreementTypeT  @default(consignment) @map("agreement_type")
  saleMode             SaleModeT       @default(platform_sale) @map("sale_mode")
  commissionPubPercent Decimal         @map("commission_pub_percent")
  dateHung             DateTime?       @map("date_hung") @db.Date
  notes                String?
  createdAt            DateTime        @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt            DateTime        @updatedAt @map("updated_at") @db.Timestamptz()

  business Business       @relation(fields: [businessId], references: [id])
  artist   Artist          @relation(fields: [artistId], references: [id])
  photos   ArtworkPhoto[]

  @@index([businessId, status], map: "ix_artworks_business_status")
  @@index([artistId], map: "ix_artworks_artist")
  @@map("artworks")
}

model ArtworkPhoto {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  artworkId    String   @map("artwork_id") @db.Uuid
  storageKey   String   @map("storage_key")
  url          String
  thumbnailKey String?  @map("thumbnail_key")
  thumbnailUrl String?  @map("thumbnail_url")
  sortOrder    Int      @default(0) @map("sort_order")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz()

  artwork Artwork @relation(fields: [artworkId], references: [id], onDelete: Cascade)

  @@index([artworkId], map: "ix_artwork_photos_artwork")
  @@map("artwork_photos")
}

// ─── Password Reset ─────────────────────────────────────────

model PasswordResetToken {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  token     String   @unique
  expiresAt DateTime @map("expires_at") @db.Timestamptz()
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz()

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_reset_tokens")
}
